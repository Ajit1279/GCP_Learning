- Reference: https://www.youtube.com/watch?v=uGcDt7iNFkE&list=PLl4APkPHzsUUOkOv3i62UidrLmSB8DcGC&index=24
- https://www.youtube.com/watch?v=DswQe7shSa4&list=PLl4APkPHzsUUOkOv3i62UidrLmSB8DcGC&index=25

- Basics:
  - In pervious lesson, we only set the authentication (certificates) for the user (Newadmin)
  - In this lesson, we'll set-up his authorization for him to be able to access the resources
  - There are series of commands (in the demo below) which we'll have to run to check the access levels
  - The yaml contains **"rules"** instead of specs. Within rules, we've
    - **apiGroup:** It can be inferred from the apiVersion tag of the yaml. if it's only v1, it's a core group, but in few cases it contains additional group (e.g. rbac.authorization.k8s.io/v1).
    - **resources:** Any of the kubernetes objects like pods, nodes, clusters etc.
    - **verb:** Type of access we want to grant


       ![image](https://github.com/user-attachments/assets/9d2290d3-04e7-4fe6-b924-079772d5b416)

  - There are few roles which are cluster level

     ![image](https://github.com/user-attachments/assets/c647d946-261a-4a67-932b-0d26b4aab1f7)

  - Please also note that **non-cluster roles** which are **not limited to particular namespace** are also **considered cluster roles**
      
 -----------------------------------------------------------------------
 - Demo
   - In day 22 video, we only set-up the authentication for the users. In this demo we'll set-up authorization so that the users can access the required resources
  
   - To check if the default user has access to run command, run:

           sudo kubectl auth whoami
  
   - It gave an error:

       ![image](https://github.com/user-attachments/assets/a557ca7a-0923-4640-9fe7-83cba7d017cb)

   - Run the command

          kubectl config get-users --help

       ![image](https://github.com/user-attachments/assets/6dc37e72-5d5b-49fb-81ec-780dde4fdef9)

   - Kubernetes does not come with a built-in identity management (IDM) system; rather, external IDMs or user/password mapping files can be configured. 

   - Run the below command. As observed, there's a **role admin, cluster-admin, basic-user**

           sudo kubectl get clusterroles -A | less

      ![image](https://github.com/user-attachments/assets/1d1b0d2a-9b7b-4ddc-aa43-7348ff38631d)

     
   - Now run the command
     
           sudo kubectl auth can-i get pod --as basic-user
           sudo kubectl auth can-i get pod --as admin
           sudo kubectl auth can-i get pod --as cluster-admin
 

   - Create [role.yaml](https://github.com/Ajit1279/GCP_Learning/blob/main/Docker_K8S/K8S/concepts/role.yaml) for **creating a role**

   - There are two types of roles in API, i) Core group: If in the apiVersion, there's nothing after version (v1,v2 etc.), then it's core group ii) named group: The rbac yaml contains rbac.authorization.k8s.io/v1. These are named groups 

   - Let's apply this yaml

          sudo kubectl apply -f role.yaml
          sudo kubectl get roles
          sudo kubectl describe role pod-reader

      ![image](https://github.com/user-attachments/assets/002fc5dd-c1a2-4eef-9a46-dd6b653d42ed)


   - We'll create "Role Binding to bind these roles with the users. Please create [binding.yaml](https://github.com/Ajit1279/GCP_Learning/blob/main/Docker_K8S/K8S/concepts/binding.yaml)

          vi binding.yaml
          sudo kubectl apply -f binding.yaml
          sudo kubectl get rolebinding
          sudo kubectl describe rolebinding read-pods

     ![image](https://github.com/user-attachments/assets/3e7b2663-8f37-4410-b60d-4aaf1f0dcda1)


   - Now check if the user has access to get pods

         sudo kubectl auth can-i get pod --as newadmin

      ![image](https://github.com/user-attachments/assets/8cfbb989-6d9c-4848-b853-b75dc0fa8c47)

   - Now we'll have to login as user and run few commands. For that we need to add an entry into kubeconfig. As a pre-requisites, we'll need to create certificates and keys for user as shown in [SSL, TLS demo](https://github.com/Ajit1279/GCP_Learning/blob/main/Docker_K8S/K8S/concepts/241018_TLSCerts_in_K8S.md). Create newadmin.crt by copying the output of last step in this demo

         sudo kubectl config set-credentials newadmin \
         --client-key=newadmin.key \
         --client-certificate=newadmin.crt \
         --embed-certs=true

      ![image](https://github.com/user-attachments/assets/cb467c12-40ae-4536-a14a-a5e124168b7e)

   - Now we have to set the context

         sudo kubectl config set-context newadmin --cluster=kind-dev \
         --user newadmin

      ![image](https://github.com/user-attachments/assets/12be7be0-6301-4928-9edf-a73774c35733)

   - Let's check this context now

         sudo kubectl config get-contexts

      ![image](https://github.com/user-attachments/assets/73e899a0-38fa-4273-9810-d290dc920f56)

   - Set the newadmin as new context

         sudo kubectl config set-context newadmin
         sudo kubectl config get-contexts

      ![image](https://github.com/user-attachments/assets/da97dc83-df42-4e5c-9281-df9c0e53f8e3)

   - Try other commands which the user is not authorised to do e.g.

         sudo kubectl get deploy --as newadmin

   - It returned error

      ![image](https://github.com/user-attachments/assets/9cc2f9b6-6a2c-43ec-b73f-ce005996393a)

   - Run the command to resolve it

          openssl x509 -inform der -in newadmin.crt -out newadmin.pem

--------------------------------------------------------------------------
          
  - We'll start all over again from 19:15
  
  - Create VM instance, install docker, kind, kubectl on it
  
  - Create a kind cluster on it

            sudo kind create cluster --name dev
            sudo kind create cluster --name test

      ![image](https://github.com/user-attachments/assets/d3544bde-2e31-46af-83dc-de7dd98395b6)

  - Follow instructions to create [TLS certificate](https://github.com/Ajit1279/GCP_Learning/blob/main/Docker_K8S/K8S/concepts/241018_TLSCerts_in_K8S.md)
  
    - Create a new user key

            openssl genrsa -out newuser.key 2048

    - Create a new Certificate Signing Request using this key

            openssl req -new -key newuser.key -out newuser.csr -subj "/CN=newuser"

    - Let's encode the csr key with base64

            cat newuser.csr | base64

    - Create csr.yaml similar to [certsign.yaml](https://github.com/Ajit1279/GCP_Learning/blob/main/Docker_K8S/K8S/concepts/certsign.yaml)       

